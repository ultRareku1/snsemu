<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GreenChat Snapshot Creator ‚Äì Nova X Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=DM+Sans:wght@400;500;600;700&family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --app-green: #07C160;
    --app-bg: #EDEDED;
    --app-header: #EDEDED;
    --app-white: #FFFFFF;
    --app-text: #111111;
    --app-time: #B2B2B2;
    --app-bubble-other: #FFFFFF;
    --app-bubble-me: #95EC69;
    --panel-bg: #0d1117;
    --panel-surface: #161b22;
    --panel-surface2: #1c2129;
    --panel-border: rgba(255,255,255,0.06);
    --panel-text: #c9d1d9;
    --panel-highlight: #07C160;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', 'Noto Sans SC', sans-serif;
    background: var(--panel-bg);
    background-image: 
      radial-gradient(ellipse at 20% 50%, rgba(7,193,96,0.04) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 20%, rgba(26,115,232,0.04) 0%, transparent 50%);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 30px 20px;
    color: var(--panel-text);
  }

  .app-container {
    display: flex;
    gap: 44px;
    max-width: 1140px;
    width: 100%;
    flex-wrap: wrap;
    justify-content: center;
  }

  /* ‚îÄ‚îÄ EDITOR PANEL ‚îÄ‚îÄ */
  .editor-panel {
    width: 390px;
    background: var(--panel-surface);
    border-radius: 20px;
    padding: 28px;
    border: 1px solid var(--panel-border);
    box-shadow: 0 24px 80px rgba(0,0,0,0.4);
    display: flex;
    flex-direction: column;
    gap: 20px;
    animation: fadeUp 0.5s ease;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .editor-title {
    font-size: 20px;
    font-weight: 700;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .editor-title .badge {
    font-size: 10px;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 6px;
    background: rgba(7,193,96,0.15);
    color: var(--panel-highlight);
    letter-spacing: 0.5px;
  }

  .section-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.8px;
    color: var(--panel-highlight);
    margin-bottom: 2px;
  }

  .field-group { display: flex; flex-direction: column; gap: 6px; }

  label {
    font-size: 12px;
    font-weight: 500;
    color: rgba(255,255,255,0.5);
  }

  input[type="text"], textarea, select {
    width: 100%;
    background: var(--panel-surface2);
    border: 1px solid var(--panel-border);
    border-radius: 10px;
    padding: 10px 14px;
    color: #e6edf3;
    font-size: 13px;
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  input:focus, textarea:focus, select:focus {
    border-color: var(--panel-highlight);
    box-shadow: 0 0 0 3px rgba(7,193,96,0.1);
  }

  textarea { resize: vertical; min-height: 50px; }

  select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
  }
  select option { background: #1c2129; color: #fff; }

  .avatar-upload-area {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .avatar-preview {
    width: 46px;
    height: 46px;
    border-radius: 10px;
    background: var(--panel-surface2);
    overflow: hidden;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    cursor: pointer;
    border: 2px dashed rgba(255,255,255,0.12);
    transition: border-color 0.2s;
    position: relative;
  }
  .avatar-preview:hover { border-color: var(--panel-highlight); }
  .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }

  .avatar-upload-hint {
    font-size: 11px;
    color: rgba(255,255,255,0.35);
    line-height: 1.5;
  }

  .messages-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 250px;
    overflow-y: auto;
    padding-right: 4px;
  }
  .messages-list::-webkit-scrollbar { width: 3px; }
  .messages-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 2px; }

  .msg-item {
    background: var(--panel-surface2);
    border-radius: 10px;
    padding: 10px 12px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    border: 1px solid var(--panel-border);
  }

  .msg-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .msg-sender-tag {
    font-size: 10px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 5px;
    background: rgba(7,193,96,0.12);
    color: var(--panel-highlight);
    letter-spacing: 0.3px;
  }
  .msg-sender-tag.me {
    background: rgba(100,149,237,0.12);
    color: cornflowerblue;
  }

  .msg-delete {
    background: none;
    border: none;
    color: rgba(255,255,255,0.25);
    cursor: pointer;
    font-size: 14px;
    padding: 2px 6px;
    border-radius: 4px;
    transition: all 0.15s;
  }
  .msg-delete:hover { color: #ff6b6b; background: rgba(255,107,107,0.1); }

  .msg-item textarea {
    min-height: 34px;
    font-size: 12px;
    padding: 8px 10px;
  }

  .btn-row { display: flex; gap: 8px; }

  .btn {
    flex: 1;
    padding: 10px 14px;
    border: none;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--panel-highlight);
    color: #fff;
  }
  .btn-primary:hover { background: #06a953; transform: translateY(-1px); }

  .btn-secondary {
    background: rgba(255,255,255,0.06);
    color: rgba(255,255,255,0.6);
  }
  .btn-secondary:hover { background: rgba(255,255,255,0.1); }

  .btn-export {
    background: linear-gradient(135deg, var(--panel-highlight), #06a953);
    color: #fff;
    padding: 13px;
    font-size: 14px;
    border-radius: 12px;
    width: 100%;
    border: none;
    font-weight: 700;
    font-family: inherit;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .btn-export:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(7,193,96,0.3);
  }

  .hint-text {
    font-size: 11px;
    color: rgba(255,255,255,0.25);
    text-align: center;
  }

  /* ‚îÄ‚îÄ PHONE PREVIEW (Nova X Pro) ‚îÄ‚îÄ */
  .preview-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 14px;
    animation: fadeUp 0.5s ease 0.1s both;
  }

  .phone-frame {
    width: 380px;
    height: 800px;
    background: #000;
    border-radius: 16px;
    overflow: hidden;
    box-shadow:
      0 0 0 2px #2a2a2a,
      0 0 0 4px #111,
      0 40px 100px rgba(0,0,0,0.6);
    display: flex;
    flex-direction: column;
    position: relative;
  }

  /* Nova X Pro - very boxy with slight rounded corners */

  /* ‚îÄ‚îÄ Status Bar (Clarity UI) ‚îÄ‚îÄ */
  .device-status-bar {
    background: var(--app-header);
    padding: 0 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 32px;
    flex-shrink: 0;
    position: relative;
  }

  /* Punch-hole camera cutout */
  .punch-hole {
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #000;
    z-index: 10;
    box-shadow: 0 0 0 1.5px #1a1a1a;
  }

  .status-left {
    display: flex;
    align-items: center;
    gap: 2px;
  }

  .status-time-device {
    font-size: 12px;
    font-weight: 600;
    color: #1a1a1a;
    font-family:  'DM Sans', sans-serif;
    letter-spacing: -0.2px;
  }

  .status-right {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* ‚îÄ‚îÄ GreenChat Chat Header (mobile style) ‚îÄ‚îÄ */
  .chat-header-device {
    background: var(--app-header);
    padding: 8px 12px 10px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
    border-bottom: 0.5px solid rgba(0,0,0,0.06);
  }

  .chat-header-back-device {
    display: flex;
    align-items: center;
    padding: 4px;
    color: #1a1a1a;
  }

  .chat-header-info {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .chat-header-name-device {
    font-size: 17px;
    font-weight: 500;
    color: #1a1a1a;
    font-family: 'Noto Sans SC', sans-serif;
    line-height: 1.2;
  }

  .chat-header-actions {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  /* ‚îÄ‚îÄ Chat Body ‚îÄ‚îÄ */
  .chat-body {
    flex: 1;
    overflow-y: auto;
    padding: 10px 14px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: var(--app-bg);
  }
  .chat-body::-webkit-scrollbar { display: none; }

  .chat-time-divider {
    text-align: center;
    font-size: 11px;
    color: #999;
    padding: 6px 0;
    font-family: 'Noto Sans SC', sans-serif;
  }

  .chat-msg {
    display: flex;
    gap: 8px;
    align-items: flex-start;
    max-width: 100%;
  }
  .chat-msg.me { flex-direction: row-reverse; }

  .chat-msg-avatar {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    overflow: hidden;
    flex-shrink: 0;
    background: #ccc;
  }
  .chat-msg-avatar img { width: 100%; height: 100%; object-fit: cover; }

  .chat-msg-bubble {
    max-width: 230px;
    padding: 10px 12px;
    border-radius: 6px;
    font-size: 15px;
    line-height: 1.45;
    color: var(--app-text);
    word-break: break-word;
    position: relative;
    font-family: 'Noto Sans SC', -apple-system, 'Roboto', sans-serif;
  }

  .chat-msg:not(.me) .chat-msg-bubble {
    background: var(--app-bubble-other);
    border-top-left-radius: 2px;
  }
  .chat-msg.me .chat-msg-bubble {
    background: var(--app-bubble-me);
    border-top-right-radius: 2px;
  }

  /* Bubble arrows */
  .chat-msg:not(.me) .chat-msg-bubble::before {
    content: '';
    position: absolute;
    left: -6px;
    top: 10px;
    width: 0; height: 0;
    border-top: 6px solid transparent;
    border-bottom: 6px solid transparent;
    border-right: 6px solid var(--app-bubble-other);
  }
  .chat-msg.me .chat-msg-bubble::before {
    content: '';
    position: absolute;
    right: -6px;
    top: 10px;
    width: 0; height: 0;
    border-top: 6px solid transparent;
    border-bottom: 6px solid transparent;
    border-left: 6px solid var(--app-bubble-me);
  }

  /* ‚îÄ‚îÄ Bottom Input Bar ‚îÄ‚îÄ */
  .chat-bottom-bar {
    background: #f7f7f7;
    padding: 8px 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    border-top: 0.5px solid rgba(0,0,0,0.06);
    flex-shrink: 0;
  }

  .chat-input-fake {
    flex: 1;
    background: #fff;
    border-radius: 6px;
    height: 36px;
    border: 0.5px solid rgba(0,0,0,0.1);
  }

  .bottom-icon { color: #444; }

  /* ‚îÄ‚îÄ Navigation Bar (Nova gesture bar) ‚îÄ‚îÄ */
  .device-nav-bar {
    background: var(--app-bg);
    height: 28px;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
    padding-bottom: 4px;
  }

  .gesture-bar {
    width: 120px;
    height: 4px;
    border-radius: 4px;
    background: rgba(0,0,0,0.25);
  }

  @media (max-width: 880px) {
    .app-container { flex-direction: column; align-items: center; }
    .editor-panel { width: 100%; max-width: 400px; }
  }
</style>
</head>
<body>

<div class="app-container">
  <!-- ‚îÄ‚îÄ Editor Panel ‚îÄ‚îÄ -->
  <div class="editor-panel">
    <div class="editor-title">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <rect x="2" y="2" width="20" height="20" rx="5" fill="#07C160"/>
        <path d="M8.5 10.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S10.83 12 10 12s-1.5-.67-1.5-1.5zm4 0c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5z" fill="#fff"/>
        <path d="M7 14s1.5 2 5 2 5-2 5-2" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      GreenChat Snapshot
      <span class="badge">Nova X Pro</span>
    </div>

    <!-- Status Bar Time -->
    <div class="field-group">
      <div class="section-label">Status Bar</div>
      <label>Time Display</label>
      <input type="text" id="statusTime" value="10:28" oninput="render()" placeholder="e.g. 10:28">
      <label>Battery %</label>
      <input type="text" id="batteryPct" value="85" oninput="render()" placeholder="e.g. 85" style="width:80px">
    </div>

    <!-- Contact -->
    <div class="field-group">
      <div class="section-label">Contact</div>
      <label>Name</label>
      <input type="text" id="otherName" value="Êñá‰ª∂‰º†ËæìÂä©Êâã" oninput="render()" placeholder="Contact name">
      <label>Avatar</label>
      <div class="avatar-upload-area">
        <div class="avatar-preview" onclick="document.getElementById('otherAvatarInput').click()" id="otherAvatarPreview">üë§</div>
        <input type="file" id="otherAvatarInput" accept="image/*" hidden onchange="loadAvatar(this,'other')">
        <span class="avatar-upload-hint">Click to upload<br>contact avatar</span>
      </div>
    </div>

    <!-- Me -->
    <div class="field-group">
      <div class="section-label">Me</div>
      <label>Avatar</label>
      <div class="avatar-upload-area">
        <div class="avatar-preview" onclick="document.getElementById('myAvatarInput').click()" id="myAvatarPreview">üôÇ</div>
        <input type="file" id="myAvatarInput" accept="image/*" hidden onchange="loadAvatar(this,'me')">
        <span class="avatar-upload-hint">Click to upload<br>your avatar</span>
      </div>
    </div>

    <!-- Messages -->
    <div class="field-group">
      <div class="section-label">Messages</div>
      <div class="messages-list" id="messagesList"></div>
      <div class="btn-row">
        <button class="btn btn-secondary" onclick="addMessage('other')">+ Contact</button>
        <button class="btn btn-primary" onclick="addMessage('me')">+ Me</button>
      </div>
    </div>

    <!-- Time Divider -->
    <div class="field-group">
      <label>Time Divider</label>
      <input type="text" id="timeDivider" value="Êò®Â§© 10:32" oninput="render()" placeholder="e.g. Êò®Â§© 10:32">
    </div>

    <!-- Export -->
    <button class="btn-export" onclick="exportImage()">üì∏  Export as PNG</button>
    <div class="hint-text">2x retina resolution export</div>
  </div>

  <!-- ‚îÄ‚îÄ Nova X Pro Phone Preview ‚îÄ‚îÄ -->
  <div class="preview-container">
    <div class="phone-frame" id="phoneFrame">

      <!-- Status Bar (Clarity UI style) -->
      <div class="device-status-bar">
        <div class="punch-hole"></div>
        <div class="status-left">
          <span class="status-time-device" id="previewStatusTime">10:28</span>
        </div>
        <div class="status-right">
          <!-- Mobile signal -->
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
            <rect x="0" y="10" width="2.5" height="4" rx="0.5" fill="#1a1a1a"/>
            <rect x="3.8" y="7" width="2.5" height="7" rx="0.5" fill="#1a1a1a"/>
            <rect x="7.6" y="4" width="2.5" height="10" rx="0.5" fill="#1a1a1a"/>
            <rect x="11.4" y="1" width="2.5" height="13" rx="0.5" fill="#1a1a1a" opacity="0.3"/>
          </svg>
          <!-- WiFi -->
          <svg width="14" height="12" viewBox="0 0 16 14" fill="#1a1a1a">
            <path d="M8 11.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
            <path d="M4.93 8.07a4.24 4.24 0 016.14 0" stroke="#1a1a1a" stroke-width="1.5" fill="none" stroke-linecap="round"/>
            <path d="M2.1 5.24a8.08 8.08 0 0111.8 0" stroke="#1a1a1a" stroke-width="1.5" fill="none" stroke-linecap="round"/>
          </svg>
          <!-- Battery with percentage -->
          <span id="previewBattery" style="font-size:10px;font-weight:600;color:#1a1a1a;font-family:'DM Sans',sans-serif;">85%</span>
          <svg width="22" height="11" viewBox="0 0 22 11" fill="none">
            <rect x="0.5" y="0.5" width="18.5" height="10" rx="2" stroke="#1a1a1a" stroke-width="1"/>
            <rect x="20" y="3" width="1.8" height="5" rx="0.5" fill="#1a1a1a"/>
            <rect id="batteryFill" x="2" y="2" width="15.5" height="7" rx="1" fill="#1a1a1a"/>
          </svg>
        </div>
      </div>

      <!-- GreenChat Chat Header (mobile style) -->
      <div class="chat-header-device">
        <div class="chat-header-back-device">
          <svg width="10" height="18" viewBox="0 0 10 18"><path d="M9 1L1 9l8 8" stroke="#1a1a1a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <div class="chat-header-info">
          <span class="chat-header-name-device" id="previewHeaderName">Êñá‰ª∂‰º†ËæìÂä©Êâã</span>
        </div>
        <div class="chat-header-actions">
          <!-- more/overflow menu icon -->
          <svg width="20" height="20" viewBox="0 0 20 20" fill="#1a1a1a">
            <circle cx="10" cy="4" r="1.8"/>
            <circle cx="10" cy="10" r="1.8"/>
            <circle cx="10" cy="16" r="1.8"/>
          </svg>
        </div>
      </div>

      <!-- Chat Messages Body -->
      <div class="chat-body" id="chatBody"></div>

      <!-- Bottom Input Bar -->
      <div class="chat-bottom-bar">
        <!-- Voice icon -->
        <svg class="bottom-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
          <rect x="9" y="3" width="6" height="11" rx="3" stroke="#444" stroke-width="1.5"/>
          <path d="M5 12a7 7 0 0014 0" stroke="#444" stroke-width="1.5" stroke-linecap="round"/>
          <line x1="12" y1="19" x2="12" y2="22" stroke="#444" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        <div class="chat-input-fake"></div>
        <!-- Emoji icon -->
        <svg class="bottom-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="9" stroke="#444" stroke-width="1.5"/>
          <circle cx="9" cy="10.5" r="1" fill="#444"/>
          <circle cx="15" cy="10.5" r="1" fill="#444"/>
          <path d="M8.5 14.5s1.5 2 3.5 2 3.5-2 3.5-2" stroke="#444" stroke-width="1.3" stroke-linecap="round"/>
        </svg>
        <!-- Plus / More icon -->
        <svg class="bottom-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="9" stroke="#444" stroke-width="1.5"/>
          <line x1="12" y1="8" x2="12" y2="16" stroke="#444" stroke-width="1.5" stroke-linecap="round"/>
          <line x1="8" y1="12" x2="16" y2="12" stroke="#444" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </div>

      <!-- Gesture Navigation Bar -->
      <div class="device-nav-bar">
        <div class="gesture-bar"></div>
      </div>
    </div>
    <div class="hint-text">Nova X Pro ¬∑ Clarity UI</div>
  </div>
</div>

<script>
  let messages = [
    { sender: 'other', text: '‰Ω†Â•ΩÔºÅÊúÄËøëÊÄé‰πàÊ†∑Ôºü' },
    { sender: 'me', text: 'Êå∫Â•ΩÁöÑÔºåË∞¢Ë∞¢ÂÖ≥ÂøÉ üòä' },
    { sender: 'other', text: 'Âë®Êú´ÊúâÁ©∫ÂêóÔºü‰∏ÄËµ∑ÂêÉ‰∏™È•≠' },
    { sender: 'me', text: 'Â•ΩÂïäÔºåÂë®ÂÖ≠‰∏≠ÂçàÂèØ‰ª•ÂêóÔºü' },
  ];

  let avatars = { other: null, me: null };

  const defaultAvatars = {
    other: generateDefaultAvatar('#07C160', 'Âèã'),
    me: generateDefaultAvatar('#4A90D9', 'Êàë')
  };

  function generateDefaultAvatar(color, char) {
    const c = document.createElement('canvas');
    c.width = 80; c.height = 80;
    const ctx = c.getContext('2d');
    ctx.fillStyle = color;
    ctx.fillRect(0, 0, 80, 80);
    ctx.fillStyle = '#fff';
    ctx.font = '600 36px "Noto Sans SC", sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(char, 40, 42);
    return c.toDataURL();
  }

  function loadAvatar(input, who) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      avatars[who] = e.target.result;
      const id = who === 'me' ? 'myAvatarPreview' : 'otherAvatarPreview';
      document.getElementById(id).innerHTML = `<img src="${e.target.result}">`;
      render();
    };
    reader.readAsDataURL(file);
  }

  function addMessage(sender) {
    messages.push({ sender, text: '' });
    renderEditor();
    render();
    const list = document.getElementById('messagesList');
    const ta = list.querySelectorAll('textarea');
    if (ta.length) ta[ta.length - 1].focus();
  }

  function removeMessage(i) {
    messages.splice(i, 1);
    renderEditor();
    render();
  }

  function updateMessage(i, text) {
    messages[i].text = text;
    render();
  }

  function renderEditor() {
    document.getElementById('messagesList').innerHTML = messages.map((m, i) => `
      <div class="msg-item">
        <div class="msg-item-header">
          <span class="msg-sender-tag ${m.sender}">${m.sender === 'me' ? 'Me' : 'Contact'}</span>
          <button class="msg-delete" onclick="removeMessage(${i})">‚úï</button>
        </div>
        <textarea placeholder="Type message..." oninput="updateMessage(${i}, this.value)">${m.text}</textarea>
      </div>
    `).join('');
  }

  function getAvatar(who) {
    return avatars[who] || defaultAvatars[who];
  }

  function render() {
    const time = document.getElementById('statusTime').value;
    const bat = document.getElementById('batteryPct').value;
    document.getElementById('previewStatusTime').textContent = time;
    document.getElementById('previewHeaderName').textContent = document.getElementById('otherName').value;

    // Battery
    document.getElementById('previewBattery').textContent = bat + '%';
    const pct = Math.max(0, Math.min(100, parseInt(bat) || 0));
    const maxW = 15.5;
    document.getElementById('batteryFill').setAttribute('width', (maxW * pct / 100).toFixed(1));
    if (pct <= 20) {
      document.getElementById('batteryFill').setAttribute('fill', '#ff4444');
    } else {
      document.getElementById('batteryFill').setAttribute('fill', '#1a1a1a');
    }

    // Messages
    const body = document.getElementById('chatBody');
    const td = document.getElementById('timeDivider').value;
    let html = '';
    if (td) html += `<div class="chat-time-divider">${td}</div>`;

    messages.forEach(m => {
      const isMe = m.sender === 'me';
      const avatar = getAvatar(m.sender);
      const text = (m.text || '').replace(/\n/g, '<br>');
      html += `
        <div class="chat-msg ${isMe ? 'me' : ''}">
          <div class="chat-msg-avatar"><img src="${avatar}"></div>
          <div class="chat-msg-bubble">${text || '&nbsp;'}</div>
        </div>`;
    });

    body.innerHTML = html;
    body.scrollTop = body.scrollHeight;
  }

  function exportImage() {
    const frame = document.getElementById('phoneFrame');
    const btn = document.querySelector('.btn-export');
    btn.textContent = '‚è≥ Generating...';

    if (!window.html2canvas) {
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
      s.onload = () => doExport(frame, btn);
      s.onerror = () => {
        btn.textContent = 'üì∏  Export as PNG';
        alert('Could not load export library. Try taking a screenshot of the preview.');
      };
      document.head.appendChild(s);
    } else {
      doExport(frame, btn);
    }
  }

  function doExport(frame, btn) {
    html2canvas(frame, { scale: 2, useCORS: true, backgroundColor: null }).then(canvas => {
      const link = document.createElement('a');
      link.download = 'greenchat-nova-x-pro-snapshot.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
      btn.textContent = '‚úÖ Saved!';
      setTimeout(() => btn.textContent = 'üì∏  Export as PNG', 2000);
    }).catch(() => {
      btn.textContent = 'üì∏  Export as PNG';
      alert('Export failed.');
    });
  }

  renderEditor();
  render();
</script>
</body>
</html>
