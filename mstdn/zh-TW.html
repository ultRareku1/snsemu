<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mastodon 貼文生成器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- 基礎樣式 --- */
        :root {
            --bg-body: #191b22;
            --bg-card: #282c37;
            --text-primary: #ffffff;
            --text-secondary: #9baec8;
            --accent: #6364ff;
            --border-color: #393f4f;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-stack);
            background-color: #111;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            min-height: 100vh;
        }

        .container {
            display: flex;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            flex-wrap: wrap;
        }

        /* 左側控制區 */
        .controls {
            flex: 1;
            min-width: 320px;
            padding: 20px;
            background: #222;
            border-right: 1px solid #333;
            overflow-y: auto;
            max-height: 100vh;
        }

        .controls h2 { margin-top: 0; display: flex; align-items: center; gap: 10px; font-size: 1.2rem; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #ccc; font-size: 0.9em; font-weight: bold; }
        
        .input-wrapper { display: flex; flex-direction: column; gap: 5px; }
        
        input[type="text"], input[type="number"], textarea, select {
            width: 100%;
            padding: 8px;
            background: #333;
            border: 1px solid #444;
            color: white;
            border-radius: 4px;
            box-sizing: border-box;
        }

        input[type="file"] {
            background: #333; padding: 5px; border-radius: 4px; border: 1px solid #444; color: #aaa; width: 100%;
        }

        textarea { height: 80px; resize: vertical; }

        /* 選項按鈕組 */
        .radio-group {
            display: flex;
            gap: 10px;
            background: #333;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #444;
        }
        .radio-group label {
            flex: 1;
            margin: 0;
            text-align: center;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            font-size: 12px;
            color: #888;
            transition: 0.2s;
        }
        .radio-group input[type="radio"] { display: none; }
        .radio-group input[type="radio"]:checked + label {
            background: var(--accent);
            color: white;
            font-weight: bold;
        }

        /* 下載按鈕 */
        .btn-download {
            width: 100%; padding: 12px;
            background-color: var(--accent); color: white;
            border: none; border-radius: 4px;
            font-size: 16px; font-weight: bold;
            cursor: pointer; margin-top: 10px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-download:hover { background-color: #5658dd; }
        .btn-download:disabled { background-color: #444; cursor: not-allowed; }

        /* 右側預覽區 */
        .preview-area {
            flex: 1;
            min-width: 350px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--bg-body);
            padding: 40px;
            position: relative;
        }

        .preview-label {
            position: absolute; top: 10px; right: 10px;
            background: #333; padding: 5px 10px;
            border-radius: 4px; font-size: 12px; color: #aaa;
        }

        /* --- Mastodon Card 核心樣式 --- */
        .toot-card {
            background-color: var(--bg-card);
            width: 100%;
            max-width: 550px;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            box-sizing: border-box; 
        }

        .toot-header { display: flex; align-items: center; margin-bottom: 15px; }

        .avatar {
            width: 48px; height: 48px;
            border-radius: 4px; object-fit: cover;
            margin-right: 12px; background-color: #444; flex-shrink: 0;
        }

        .user-meta { display: flex; flex-direction: column; overflow: hidden; }
        .display-name { font-weight: 700; font-size: 15px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .username { color: var(--text-secondary); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .toot-content {
            font-size: 19px; line-height: 1.5; color: var(--text-primary);
            margin-bottom: 15px; white-space: pre-wrap; word-wrap: break-word;
        }
        .toot-content a { color: #8c8dff; text-decoration: none; }

        /* --- 圖片顯示邏輯 (關鍵修復) --- */
        .media-container {
            margin-top: 10px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            display: none; /* JS控制顯示 */
            background: #000;
        }

        .media-image {
            display: block;
            width: 100%; 
            /* 預設為全尺寸模式 */
            height: auto;
            max-height: none;
            object-fit: contain; 
        }

        /* 模式1：裁切填充 (類似 Timeline) */
        .media-image.mode-cover {
            height: 300px; /* 固定高度 */
            object-fit: cover; /* 裁切多餘部分 */
        }

        /* 模式2：完整原圖 (Details View) - 這是截圖最安全的模式 */
        .media-image.mode-full {
            height: auto;
            max-height: none;
            object-fit: contain;
        }

        .toot-date { color: var(--text-secondary); font-size: 15px; margin: 15px 0; font-weight: 500; }
        .divider { height: 1px; background-color: var(--border-color); margin: 0; }
        .stats-bar { padding: 15px 0; display: flex; gap: 20px; font-size: 15px; }
        .stats-bar strong { color: #fff; font-weight: 700; }
        .stats-bar span { color: var(--text-secondary); }
        .action-bar { display: flex; justify-content: space-between; padding-top: 10px; }
        .action-item { color: var(--text-secondary); font-size: 20px; padding: 10px; }

        @media (max-width: 800px) {
            .container { flex-direction: column; }
            .preview-area { padding: 10px; }
            .controls { max-height: none; border-bottom: 1px solid #333; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="controls">
        <h2><i class="fa-brands fa-mastodon" style="color:var(--accent);"></i> 貼文生成器</h2>
        
        <div class="form-group">
            <label>顯示名稱 & ID</label>
            <input type="text" id="inputName" value="Mastodon User" oninput="updateAll()" style="margin-bottom:5px;">
            <input type="text" id="inputHandle" value="@user@instance.social" oninput="updateAll()">
        </div>

        <div class="form-group">
            <label>頭像 (建議使用本地文件)</label>
            <div class="input-wrapper">
                <input type="file" id="fileAvatar" accept="image/*" onchange="updateImageFromFile(this, 'dispAvatar')">
                <input type="text" id="inputAvatarUrl" placeholder="或圖片網址..." oninput="updateImageFromUrl('inputAvatarUrl', 'dispAvatar')">
            </div>
        </div>

        <div class="form-group">
            <label>貼文內容</label>
            <textarea id="inputContent" oninput="updateAll()">請輸入文字...</textarea>
        </div>

        <!-- 關鍵修復區域 -->
        <div class="form-group">
            <label>貼文附圖</label>
            <div class="input-wrapper">
                <input type="file" id="fileMedia" accept="image/*" onchange="updateImageFromFile(this, 'dispImage', true)">
                <input type="text" id="inputMediaUrl" placeholder="或圖片網址..." oninput="updateImageFromUrl('inputMediaUrl', 'dispImage', true)">
            </div>
            
            <label style="margin-top:10px;">圖片顯示模式 (解決截圖變形)</label>
            <div class="radio-group">
                <input type="radio" id="modeFull" name="imgMode" value="full" checked onchange="updateImgMode()">
                <label for="modeFull">完整原圖 (Full)</label>

                <input type="radio" id="modeCover" name="imgMode" value="cover" onchange="updateImgMode()">
                <label for="modeCover">裁切填充 (Crop)</label>
            </div>
            
            <button onclick="clearMedia()" style="margin-top:8px; width:100%; padding:5px; background:#444; border:none; color:#ccc; border-radius:4px; cursor:pointer;">清除圖片</button>
        </div>
        
        <div class="form-group">
            <label>日期與數據</label>
            <input type="text" id="inputTime" value="Jan 15, 2026, 12:00 PM" oninput="updateAll()" style="margin-bottom:5px;">
            <div style="display:flex; gap:10px;">
                <input type="number" id="inputBoosts" value="42" placeholder="Boosts" oninput="updateAll()">
                <input type="number" id="inputFavs" value="128" placeholder="Favs" oninput="updateAll()">
            </div>
        </div>

        <hr style="border-color:#333; margin: 20px 0;">

        <button class="btn-download" id="btnDownload" onclick="downloadImage()">
            <i class="fa-solid fa-download"></i> 下載截圖 (PNG)
        </button>
    </div>

    <div class="preview-area">
        <div class="preview-label">Live Preview</div>
        
        <div class="toot-card" id="captureTarget">
            <div class="toot-header">
                <img src="https://files.mastodon.social/accounts/avatars/000/000/001/original/1.png" id="dispAvatar" class="avatar" alt="" crossorigin="anonymous">
                <div class="user-meta">
                    <div class="display-name" id="dispName">Mastodon User</div>
                    <div class="username" id="dispHandle">@user@instance.social</div>
                </div>
            </div>

            <div class="toot-content" id="dispContent"></div>

            <div class="media-container" id="mediaContainer">
                <!-- 默認 class: mode-full -->
                <img src="" id="dispImage" class="media-image mode-full" alt="" crossorigin="anonymous">
            </div>

            <div class="toot-date">
                <span id="dispTime">Jan 15, 2026, 12:00 PM</span> · 
                <i class="fa-solid fa-earth-americas"></i> Web
            </div>

            <div class="divider"></div>

            <div class="stats-bar">
                <div><strong id="dispBoosts">42</strong> <span>轉發</span></div>
                <div><strong id="dispFavs">128</strong> <span>讚</span></div>
            </div>

            <div class="divider"></div>

            <div class="action-bar">
                <div class="action-item reply"><i class="fa-solid fa-reply"></i></div>
                <div class="action-item boost"><i class="fa-solid fa-retweet"></i></div>
                <div class="action-item fav"><i class="fa-solid fa-star"></i></div>
                <div class="action-item bookmark"><i class="fa-solid fa-bookmark"></i></div>
                <div class="action-item share"><i class="fa-solid fa-share-nodes"></i></div>
            </div>
        </div>
    </div>
</div>

<script>
    window.onload = function() {
        updateAll();
        document.getElementById('mediaContainer').style.display = 'none';
    };

    function updateAll() {
        document.getElementById('dispName').innerText = document.getElementById('inputName').value;
        document.getElementById('dispHandle').innerText = document.getElementById('inputHandle').value;
        document.getElementById('dispTime').innerText = document.getElementById('inputTime').value;
        document.getElementById('dispBoosts').innerText = document.getElementById('inputBoosts').value;
        document.getElementById('dispFavs').innerText = document.getElementById('inputFavs').value;

        const content = document.getElementById('inputContent').value;
        let formattedContent = content
            .replace(/</g, "&lt;").replace(/>/g, "&gt;") 
            .replace(/(#\w+)/g, '<a href="#">$1</a>')
            .replace(/(@\w+(@\w+\.\w+)?)/g, '<a href="#">$1</a>')
            .replace(/(https?:\/\/[^\s]+)/g, '<a href="#">$1</a>'); 
        document.getElementById('dispContent').innerHTML = formattedContent;
    }

    // 切換圖片顯示模式 (核心修復)
    function updateImgMode() {
        const img = document.getElementById('dispImage');
        const isFull = document.getElementById('modeFull').checked;
        
        if (isFull) {
            img.className = 'media-image mode-full';
        } else {
            img.className = 'media-image mode-cover';
        }
    }

    function updateImageFromUrl(inputId, imgId, isMedia = false) {
        const url = document.getElementById(inputId).value;
        const img = document.getElementById(imgId);
        if (url.trim() !== "") {
            img.src = url;
            if (isMedia) document.getElementById('mediaContainer').style.display = 'block';
        } else if (isMedia && !document.getElementById('fileMedia').files[0]) {
            document.getElementById('mediaContainer').style.display = 'none';
        }
    }

    function updateImageFromFile(input, imgId, isMedia = false) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById(imgId);
                img.src = e.target.result;
                if (isMedia) document.getElementById('mediaContainer').style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function clearMedia() {
        document.getElementById('inputMediaUrl').value = '';
        document.getElementById('fileMedia').value = '';
        document.getElementById('dispImage').src = '';
        document.getElementById('mediaContainer').style.display = 'none';
    }

    function downloadImage() {
        const captureElement = document.getElementById('captureTarget');
        const btn = document.getElementById('btnDownload');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 處理中...';
        btn.disabled = true;

        html2canvas(captureElement, {
            scale: 2,
            backgroundColor: null,
            useCORS: true,
            allowTaint: true,
            // 修正：強制使用圖片的自然寬高渲染，避免 flex 布局導致的壓縮
            imageTimeout: 0 
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'mastodon-snap-' + Date.now() + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            btn.innerHTML = originalText;
            btn.disabled = false;
        }).catch(err => {
            console.error(err);
            alert("錯誤：請嘗試使用「上傳本地圖片」代替網路圖片以避免跨域問題。");
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
</script>

</body>
</html>